// 配置
const _headersConfig = {

}
const _headersConfitStart = {
    status: false
};

function init(){
    chrome.storage.local.get(["headersConfig", "headerConfigStart"], function(headers){
        var headersConfig = headers.headersConfig;

        if(!headersConfig || !headers.headerConfigStart){
            return ;
        }

        if(headers.headerConfigStart){
            _headersConfitStart.status = true;
        }else{
            _headersConfitStart.status = false;
        }

        for(var i = 0;i < headersConfig.length;i++){
            var key = headersConfig[i].key;
            var value = headersConfig[i].value;
            var on = headersConfig[i].on;

            if(on == 1){
                _headersConfig[key] = value;
            }else{
                if(key in _headersConfig){
                    delete _headersConfig[key];
                }
            }
        }


    });
}

init();

chrome.webRequest.onBeforeRequest.addListener(function(detail) {
    // sessionStorage.setItem(detail.tabId+"", );
}, {urls: ["<all_urls>"]}, ["blocking", "requestBody"]);

chrome.webRequest.onBeforeSendHeaders.addListener(function(detail) {
    var headers = detail.requestHeaders;


    // 开关
    if(_headersConfitStart.status) {
        for(var key in _headersConfig){
            headers.push({
                name: key,
                value: _headersConfig[key]
            })
        }
        return {requestHeaders: headers};
    }
    
}, {urls: ["<all_urls>"]}, ["blocking", "requestHeaders"]);

chrome.webRequest.onResponseStarted.addListener(function(detail) {
    // console.log(detail);
}, {urls: ["<all_urls>"]});

chrome.storage.onChanged.addListener(function(changes, items){
    
    // 更新到常量中
    // for(var i = 0;i<headers.length;i++){
    //     if(headers[i].on  == 1){
    //         _headersConfig[headers[i].key] = headers[i].value;
    //     }
    // }
    init();
});

// chrome.notifications.create(null, {
//     title: "啦啦啦",
//     type: "basic",
//     iconUrl: "images/debug.png",
//     message: "message"
// }, function(item){
//     console.log(item);
// });