const UALib = {
    ua_weixin: "Mozilla/5.0 (iPhone; CPU iPhone OS 8_0 like Mac OS X) AppleWebKit/600.1.4 (KHTML, like Gecko) Mobile/12A365 MicroMessenger/5.4.1 NetType/WIFI",
    ua_ios: "Mozilla/5.0 (iPhone 6s; CPU iPhone OS 11_4_1 like Mac OS X) AppleWebKit/604.3.5 (KHTML, like Gecko) Version/11.0 MQQBrowser/8.3.0 Mobile/15B87 Safari/604.1 MttCustomUA/2 QBWebViewType/1 WKType/1",
    ua_xiaomi: "Mozilla/5.0 (Linux; U; Android 8.0.0; zh-cn; Mi Note 2 Build/OPR1.170623.032) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/61.0.3163.128 Mobile Safari/537.36 XiaoMi/MiuiBrowser/10.1.1"
}


$("#loadurl").click(function(){
    chrome.tabs.getSelected(null, function(tab){
        $("#url").val(tab.url);
    });
});

// 处理cookie
function parseCookie(cookieString){
    var cookieList = cookieString.split(";")
    var cookie = {};

    for(var i in cookieList){
        var cookieKey = cookieList[i].split("=")[0].replace(" ", "");
        var cookieValue = cookieList[i].split("=")[1];

        cookie[cookieKey] = cookieValue;
    }
    return cookie;
}

function executeModifyHeaders(details){
    var ua = $("#ua_form input").val();
    var headers = details.requestHeaders;

    if(details.url){
        for(var index in headers){
            if($("#enable_ua").is(":checked") && ua != "" && headers[index].name == 'User-Agent'){
                headers[index].value = ua;
            }
            // if(cookie != ""){
            //     cookie = parseCookie(cookie);
            //     cookie["url"] = regx_url;

            //     chrome.cookies.set(cookie, function(c){});
            // }
        }
        return {requestHeaders: headers}
    }

}

$("#execute").click(function(){
    var target = $("#url").val();
    var cookie = $("#cookie_form input").val();
    var regx_url = /(http[s]?:\/\/.*?)\//.exec(target)[0];

    chrome.webRequest.onBeforeSendHeaders.addListener(executeModifyHeaders, {urls: ["<all_urls>"], tabId: chrome.devtools.inspectedWindow.tabId}, ["blocking", "requestHeaders"]);

    chrome.tabs.update(null, {
            url: target
        }, function(){
            // chrome.webRequest.onBeforeSendHeaders.removeListener(executeModifyHeaders);
        });

});



// 编码解码
$("#urlencode").click(function(){
    var content = $("#url").val();
    $("#url").val(encodeURIComponent(content));
});

$("#urldecode").click(function(){
    var content = $("#url").val();
    $("#url").val(decodeURIComponent(content));
});

$("#b64encode").click(function(){
    var content = $("#url").val();
    $("#url").val(btoa(content));
});

$("#b64decode").click(function(){
    var content = $("#url").val();
    $("#url").val(atob(content));
});


// 设置cookie和ua
$("#enable_ua").click(function() {
    if($(this).is(":checked")){
        $("#ua_form").show();
    }else{
        $("#ua_form").hide();
    }
});

$("#enable_cookie").click(function() {
    if($(this).is(":checked")){
        $("#cookie_form").show();
    }else{
        $("#cookie_form").hide();
    }
});

// 快捷 ua
$("#fast_ua li a").click(function(){
    var ua = UALib[$(this).attr("id")];
    $("#ua_form input").val(ua);
});