const UALib = {
    ua_weixin: "Mozilla/5.0 (iPhone; CPU iPhone OS 8_0 like Mac OS X) AppleWebKit/600.1.4 (KHTML, like Gecko) Mobile/12A365 MicroMessenger/5.4.1 NetType/WIFI",
    ua_ios: "Mozilla/5.0 (iPhone 6s; CPU iPhone OS 11_4_1 like Mac OS X) AppleWebKit/604.3.5 (KHTML, like Gecko) Version/11.0 MQQBrowser/8.3.0 Mobile/15B87 Safari/604.1 MttCustomUA/2 QBWebViewType/1 WKType/1",
    ua_xiaomi: "Mozilla/5.0 (Linux; U; Android 8.0.0; zh-cn; Mi Note 2 Build/OPR1.170623.032) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/61.0.3163.128 Mobile Safari/537.36 XiaoMi/MiuiBrowser/10.1.1"
}


$("#loadurl").click(function(){
    chrome.tabs.getSelected(null, function(tab){
        $("#url").val(tab.url);
    });
});

// 处理cookie
function parseCookie(cookieString, url){
    if(cookieString == ""){
        return [];
    }

    var cookieList = cookieString.split(";")
    var cookie = new Array();

    for(var i in cookieList){
        var cookieKey = cookieList[i].split("=")[0].replace(" ", "");
        var cookieValue = cookieList[i].split("=")[1];

        // cookie[cookieKey] = cookieValue;
        cookie.push({
            url: url,
            name: cookieKey,
            value: cookieValue
        });
    }
    return cookie;
}

// 处理 post 参数
function parsePost(post_form_data){
    if(post_form_data.length == 0) {
        return [];
    }

    var post_items = post_form_data.split("&");
    var post_data_list = [];

    for(var i = 0;i<post_items.length;i++) {
        var item = post_items[i].split("=");
        var key = item[0];
        var value = item[1];
        post_data_list.push({
            key: key,
            value: value
        });
    }
    return post_data_list;
}

// 生成 input html表单代码
function generatePOSTForm(post_list) {

    var html = "";
    for(var i = 0;i<post_list.length;i++) {
        html += "<input type='hidden' name='"+post_list[i].key+"' value='"+post_list[i].value+"'>";
    }
    return html;
}

// 请求头修改绑定的方法
function executeModifyHeaders(details){
    console.log(details);
    var ua = $("#ua_form input").val();
    var referer = $("#referer_form input").val();
    var headers = details.requestHeaders;

    // 修改请求头数据
    for(var index in headers){
        if($("#enable_ua").is(":checked") && ua != "" && headers[index].name == 'User-Agent'){
            headers[index].value = ua;
        }
        if($("#enable_referer").is(":checked") && referer != "") {
            headers.push({
                name: "Referer",
                value: referer
            });
        }
    }
    return {requestHeaders: headers}
}


// 请求包 post 数据修改事件绑定
function modifyFormPost(details) {
    var target = $("#url").val();
    
    if(details.method == 'GET') {
        // detail.method = "POST";
        // detail.method = "POST";
        if(decodeURIComponent(target) == decodeURIComponent(details.url)){
            details.method = "POST";
            details.requestBody = {
                formData: {
                    c: ["test"]
                }
            };
            details.initiator = target;
        }
        return {requestBody: details.requestBody};
    }
}

$("#execute").click(function(){
    var target = $("#url").val();
    var regx_url = /(http[s]?:\/\/.*?)\//.exec(target)[0];
    var tabId = chrome.devtools.inspectedWindow.tabId;

    // 请求头绑定
    chrome.webRequest.onBeforeSendHeaders.addListener(executeModifyHeaders, 
        {urls: ["<all_urls>"], tabId: tabId}, 
        ["blocking", "requestHeaders", "extraHeaders"]);

    // POST 数据请求绑定
    // chrome.webRequest.onBeforeRequest.addListener(modifyFormPost, 
    //     {urls: ["<all_urls>"], tabId: chrome.devtools.inspectedWindow.tabId}, 
    //     ["blocking", "requestBody"]);

    // 获取 post框的数据
    if($("#enable_post").is(":checked")) {
        var post_form_data = $("#post_form textarea").val();
        var parse_post_data = parsePost(post_form_data);
        console.log(generatePOSTForm(parse_post_data));

        var input_html = generatePOSTForm(parse_post_data);
        console.log(input_html);
        chrome.tabs.executeScript(tabId, {
                code: "var extension_form = document.getElementById(\"extension_post_form\");extension_form.innerHTML = \""+input_html+"\";extension_form.submit();",
                runAt: "document_end"
            }, function(){
        })
    }else{
        chrome.tabs.update(null, {
                url: target
        }, function(){
                // chrome.webRequest.onBeforeSendHeaders.removeListener(executeModifyHeaders);
        });
    }
});

// 编码解码
$("#urlencode").click(function(){
    var content = $("#url").val();
    $("#url").val(encodeURIComponent(content));
});

$("#urldecode").click(function(){
    var content = $("#url").val();
    $("#url").val(decodeURIComponent(content));
});

$("#b64encode").click(function(){
    var content = $("#url").val();
    $("#url").val(btoa(content));
});

$("#b64decode").click(function(){
    var content = $("#url").val();
    $("#url").val(atob(content));
});


// 设置cookie和ua
$("#enable_ua").click(function() {
    if($(this).is(":checked")){
        $("#ua_form").show();
    }else{
        $("#ua_form").hide();
    }
});

$("#enable_referer").click(function() {
    if($(this).is(":checked")){
        $("#referer_form").show();
    }else{
        $("#referer_form").hide();
    }
});

$("#enable_post").click(function() {
    if($(this).is(":checked")){
        $("#post_form").show();
    }else{
        $("#post_form").hide();
    }
});

// 快捷 ua
$("#fast_ua li a").click(function(){
    var ua = UALib[$(this).attr("id")];
    $("#ua_form input").val(ua);
});