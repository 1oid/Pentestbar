const LINE_TEMP = '<tr><td><input type="text"class="form-control" value="{key}"></td><td><input type="text" value="{value}" class="form-control"></td><td><select class="form-control"><option {request_selected} value="request">请求</option><option {response_selected} value="response">响应</option></select></td><td><div class="switch"><input type="checkbox" {checked}><label>开启</label></div></td><td><button class="btn btn-danger delete" type="button">删除</button></td></tr>';
const LINE_TEMP_BLANK = '<tr><td><input type="text"class="form-control"></td><td><input type="text"class="form-control"></td><td><select class="form-control"><option value="request">请求</option><option value="response">响应</option></select></td><td><div class="switch"><input type="checkbox"><label>开启</label></div></td><td><button class="btn btn-danger delete" type="button">删除</button></td></tr>';

// 数据初始化
function init(){
    // 请求/响应头总开关显示
    chrome.storage.local.get("headerConfigStart", function(item) {
        if(item.headerConfigStart){
            $('#turnonoff').parent().find("label").text("开启");
            $("#turnonoff").attr("checked", true);
        }else{
            $('#turnonoff').parent().find("label").text("关闭");
        }
    });
    reload_data();
}

// 数据刷新
function reload_data() {
    var html_temp = "";

    chrome.storage.local.get("headersConfig", function(item){
        if(item.headersConfig == undefined){
            return;
        }

        item = item.headersConfig;

        for(var i = 0;i<item.length;i++){
            var r = LINE_TEMP.replace("{key}", item[i].key);
            r = r.replace("{value}", item[i].value);

            if(item[i].type == "request"){
                r = r.replace("{request_selected}", "selected");
            }else{
                r = r.replace("{response_selected}", "selected")
            }

            if(item[i].on == 1){
                r = r.replace("{checked}", "checked");
            }
            html_temp += r;
        }

        $("#table_body").html(html_temp);
    });
}

$(document).ready(function() {
    init();
});

// 添加新行
$("#addline").click(function() {
    $("#table_body").append(LINE_TEMP_BLANK);
});

$("#saveline").click(function() {
    var headersConfig = new Array();
    var lines = $("#table_body tr");
    console.log(lines);

    lines.each(function(index, item) {
        var _item = $(item);
        var _key = _item.find("td:eq(0) input").val();
        var _value = _item.find("td:eq(1) input").val();
        var _type = _item.find("td:eq(2) option:selected").val();
        var _on = _item.find("td:eq(3) input").is(":checked")?1:0;
        
        if(_key == "" || _value == "" || _type == ""){
            return ;
        }

        headersConfig.push({
            key: _key,
            value: _value,
            type: _type,
            on: _on
        });
    });

    // 设置
    chrome.storage.local.set({headersConfig: headersConfig}, function(t) {

    })
    // 点击按钮时显示漂浮消息
    new $.zui.Messager('保存成功。', {
        type: "success",
        time: 800,
        fade: true
    }).show();
    reload_data();
});

// 总开关
$("#turnonoff").click(function() {
    console.log($(this).is(":checked"));
    
    chrome.storage.local.set({headerConfigStart: $(this).is(":checked")}, function(){
        
    });

    if($(this).is(":checked")){
        $(this).parent().find("label").text("开启");
    }else{
        $(this).parent().find("label").text("关闭");
    }
});


// 删除
$(document).on("click", ".delete", function(){
    var o = $(this).parent().parent();
    
    // 本地存储删除
    chrome.storage.local.get("headersConfig", function(config){
        var config = config.headersConfig;
        var current_key = o.find("td input").val();
        var length = config.length;

        for(var index = 0;index<length;index++){
            if(config[index].key == current_key){
                config.pop(index);
                console.log(config);
            }
        }

        // 更新数据
        chrome.storage.local.set({headersConfig: config}, function(){});
        new $.zui.Messager('删除成功。', {
            type: "danger",
            time: 800,
            fade: true
        }).show();
        reload_data();
    });
});